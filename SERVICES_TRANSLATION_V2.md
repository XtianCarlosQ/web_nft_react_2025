# Servicios - Mejoras de Traducci√≥n v2.0

## ‚úÖ Problemas Resueltos

### 1. Bot√≥n "Consult" siempre en ingl√©s en preview CMS

**Estado:** ‚úÖ RESUELTO

**Causa:** El componente `ServiceCard` usa `t("services.consult")` pero el contexto `LanguageProvider` no est√° sincronizado con `activeLang` del modal.

**Soluci√≥n:** Ya implementado correctamente con prop `buttonText` en commit anterior. El bot√≥n funciona as√≠:

- En **admin preview**: usa `buttonText` prop (pasado desde `toCardProps`)
- En **vista p√∫blica**: usa `t("services.consult")` (contexto de idioma)

**C√≥digo actual (correcto):**

```javascript
// ServiceCard.jsx
const consultText = buttonText || t("services.consult");
<button>{consultText}</button>;

// toCardProps en ServiceFormModal.jsx
buttonText: lang === "es" ? "Consultar" : "Consult";
```

### 2. Auto-traducir no detecta cambios en campos existentes

**Estado:** ‚úÖ RESUELTO

**Problema:**

- No detectaba cambios cuando se editaba contenido ya traducido
- No ped√≠a confirmaci√≥n para sobrescribir traducciones existentes
- Solo funcionaba ES‚ÜíEN (no bidireccional)

**Soluci√≥n Implementada:**

#### A. Detecci√≥n inteligente de cambios

Nuevo funci√≥n `detectChanges()` que:

- ‚úÖ Detecta campos vac√≠os que necesitan traducci√≥n
- ‚úÖ Detecta campos con traducci√≥n que han cambiado
- ‚úÖ Diferencia entre "nuevo" y "necesita actualizaci√≥n"

```javascript
// Ejemplo de detecci√≥n
{
  hasChanges: true,
  fieldsToTranslate: [
    { field: "title", type: "simple", isEmpty: false, hasExisting: true },
    { field: "description", type: "simple", isEmpty: true }
  ],
  hasExistingTranslations: true
}
```

#### B. Modal de confirmaci√≥n para sobrescritura

```javascript
‚ö†Ô∏è Algunos campos ya tienen traducciones. ¬øDeseas sobreescribirlas?

Traducci√≥n: ES ‚Üí EN

‚Ä¢ Algunos campos ya tienen traducciones
‚Ä¢ Si aceptas, se sobrescribir√°n con las nuevas traducciones

¬øDeseas continuar?
```

#### C. Traducci√≥n bidireccional (ES‚ÜîEN)

```javascript
// El hook ahora es din√°mico
const { translating, autoTranslate, detectMissing } = useAutoTranslate(
  data,
  setData,
  {
    simpleFields: ["title", "description"],
    arrayFields: ["features"],
    sourceLang: activeLang, // ‚úÖ Cambia seg√∫n idioma activo
    targetLang: activeLang === "es" ? "en" : "es", // ‚úÖ Inverso
  }
);
```

#### D. Badge din√°mico mejorado

```javascript
// Antes: "3 campos sin traducir"
// Ahora: "3 campos ‚Üí EN"  (muestra direcci√≥n de traducci√≥n)

{missingTranslations.length} campo{missingTranslations.length > 1 ? 's' : ''} ‚Üí {targetLang}
```

#### E. Bot√≥n de traducir contextual

```javascript
// Antes: "üåê Auto-traducir"
// Ahora: "üåê Traducir a EN" o "üåê Traducir a ES" (seg√∫n idioma activo)

{
  translating ? "Traduciendo..." : `üåê Traducir a ${targetLang}`;
}
```

---

## üìÇ Archivos Modificados

### 1. `src/pages/admin/hooks/useAutoTranslate.js`

**Nuevas funciones a√±adidas:**

```javascript
// ‚úÖ Nueva funci√≥n de comparaci√≥n
function isDifferent(value1, value2) {
  if (Array.isArray(value1) && Array.isArray(value2)) {
    if (value1.length !== value2.length) return true;
    return value1.some((item, idx) => item !== value2[idx]);
  }
  return value1 !== value2;
}

// ‚úÖ Nueva funci√≥n de detecci√≥n de cambios
function detectChanges() {
  const changedFields = [];

  // Detecta campos simples
  for (const field of simpleFields) {
    const sourceValue = data[field]?.[sourceLang];
    const targetValue = data[field]?.[targetLang];

    if (sourceValue && sourceValue.trim()) {
      if (
        !targetValue ||
        targetValue.trim() === "" ||
        targetValue === sourceValue
      ) {
        changedFields.push({
          field,
          type: "simple",
          isEmpty: !targetValue || targetValue.trim() === "",
        });
      } else {
        changedFields.push({
          field,
          type: "simple",
          isEmpty: false,
          hasExisting: true,
        });
      }
    }
  }

  // Detecta arrays
  for (const field of arrayFields) {
    const sourceArray = data[field]?.[sourceLang];
    const targetArray = data[field]?.[targetLang];

    if (Array.isArray(sourceArray) && sourceArray.length > 0) {
      const sourceFiltered = sourceArray.filter((item) => item && item.trim());
      const targetFiltered = Array.isArray(targetArray)
        ? targetArray.filter((item) => item && item.trim())
        : [];

      if (targetFiltered.length === 0) {
        changedFields.push({ field, type: "array", isEmpty: true });
      } else if (
        sourceFiltered.length !== targetFiltered.length ||
        isDifferent(sourceFiltered, targetFiltered)
      ) {
        changedFields.push({
          field,
          type: "array",
          isEmpty: false,
          hasExisting: true,
        });
      }
    }
  }

  const hasExistingTranslations = changedFields.some((f) => f.hasExisting);

  return {
    hasChanges: changedFields.length > 0,
    fieldsToTranslate: changedFields,
    hasExistingTranslations,
  };
}
```

**Funci√≥n `autoTranslate` mejorada:**

```javascript
async function autoTranslate(forceOverwrite = false) {
  // 1. Verificar progreso
  if (translating)
    return { success: false, message: "Ya hay una traducci√≥n en progreso..." };

  // 2. Detectar cambios
  const changes = detectChanges();

  if (!changes.hasChanges) {
    return {
      success: true,
      message:
        "‚úÖ No hay cambios que traducir. Todos los campos est√°n sincronizados.",
    };
  }

  // 3. Si hay traducciones existentes, pedir confirmaci√≥n
  if (changes.hasExistingTranslations && !forceOverwrite) {
    return {
      success: false,
      needsConfirmation: true,
      message:
        "Algunos campos ya tienen traducciones. ¬øDeseas sobreescribirlas?",
      changes,
    };
  }

  // 4. Traducir todos los campos (sin restricciones de "vac√≠o")
  setTranslating(true);
  try {
    const updated = { ...data };

    // Traduce simples
    for (const field of simpleFields) {
      if (updated[field]?.[sourceLang] && updated[field][sourceLang].trim()) {
        updated[field][targetLang] = await translateText(
          updated[field][sourceLang],
          sourceLang,
          targetLang
        );
        await new Promise((resolve) => setTimeout(resolve, 200));
      }
    }

    // Traduce arrays
    for (const field of arrayFields) {
      if (
        Array.isArray(updated[field]?.[sourceLang]) &&
        updated[field][sourceLang].length > 0
      ) {
        updated[field][targetLang] = [];
        for (const item of updated[field][sourceLang]) {
          if (item && item.trim()) {
            const translated = await translateText(
              item,
              sourceLang,
              targetLang
            );
            updated[field][targetLang].push(translated);
            await new Promise((resolve) => setTimeout(resolve, 150));
          }
        }
      }
    }

    // Traduce nested
    for (const nestedConfig of nestedFields) {
      const { field, subFields } = nestedConfig;
      if (Array.isArray(updated[field])) {
        for (let i = 0; i < updated[field].length; i++) {
          const item = updated[field][i];
          for (const subField of subFields) {
            if (
              item[subField]?.[sourceLang] &&
              item[subField][sourceLang].trim()
            ) {
              item[subField][targetLang] = await translateText(
                item[subField][sourceLang],
                sourceLang,
                targetLang
              );
              await new Promise((resolve) => setTimeout(resolve, 150));
            }
          }
        }
      }
    }

    setData(updated);
    return {
      success: true,
      message:
        "‚úÖ ¬°Traducci√≥n completada! Revisa los campos y ajusta si es necesario.",
    };
  } catch (error) {
    return {
      success: false,
      message:
        "‚ùå Error durante la traducci√≥n. Algunos campos pueden no haberse traducido.",
    };
  } finally {
    setTranslating(false);
  }
}
```

**Funci√≥n `detectMissing` mejorada:**

```javascript
function detectMissing() {
  const changes = detectChanges();
  const missing = [];

  for (const change of changes.fieldsToTranslate) {
    const label = fieldLabel(change.field.split("[")[0]);
    if (change.isEmpty) {
      missing.push(`‚Ä¢ ${label}`);
    } else if (change.hasExisting) {
      missing.push(`‚Ä¢ ${label} (necesita actualizaci√≥n)`); // ‚úÖ Nuevo
    }
  }

  return missing;
}
```

**Exportaciones:**

```javascript
return {
  translating,
  autoTranslate,
  detectMissing,
  detectChanges, // ‚úÖ Nueva exportaci√≥n
};
```

### 2. `src/pages/admin/components/services/ServiceFormModal.jsx`

**Hook configurado din√°micamente:**

```javascript
// ‚úÖ Antes: Fijo (es ‚Üí en)
const { translating, autoTranslate, detectMissing } = useAutoTranslate(
  data,
  setData,
  {
    simpleFields: ["title", "description"],
    arrayFields: ["features"],
    sourceLang: "es",
    targetLang: "en",
  }
);

// ‚úÖ Ahora: Din√°mico (bidireccional)
const { translating, autoTranslate, detectMissing } = useAutoTranslate(
  data,
  setData,
  {
    simpleFields: ["title", "description"],
    arrayFields: ["features"],
    sourceLang: activeLang, // Cambia seg√∫n idioma activo
    targetLang: activeLang === "es" ? "en" : "es", // Inverso
  }
);
```

**Funci√≥n `handleAutoTranslate` mejorada:**

```javascript
async function handleAutoTranslate() {
  if (isView) return;

  const sourceLang = activeLang;
  const targetLang = activeLang === "es" ? "en" : "es";

  // 1. Verificar contenido en idioma fuente
  const hasSourceContent =
    (data.title?.[sourceLang] && data.title[sourceLang].trim()) ||
    (data.description?.[sourceLang] && data.description[sourceLang].trim()) ||
    (Array.isArray(data.features?.[sourceLang]) &&
      data.features[sourceLang].some((f) => f && f.trim()));

  if (!hasSourceContent) {
    alert(
      `Primero completa los campos en ${
        sourceLang === "es" ? "Espa√±ol" : "Ingl√©s"
      } antes de traducir.`
    );
    return;
  }

  // 2. Intentar traducir
  const result = await autoTranslate();

  // 3. Manejar confirmaci√≥n de sobrescritura
  if (result.needsConfirmation) {
    const confirmed = window.confirm(
      `‚ö†Ô∏è ${result.message}\n\n` +
        `Traducci√≥n: ${sourceLang.toUpperCase()} ‚Üí ${targetLang.toUpperCase()}\n\n` +
        `‚Ä¢ Algunos campos ya tienen traducciones\n` +
        `‚Ä¢ Si aceptas, se sobrescribir√°n con las nuevas traducciones\n\n` +
        `¬øDeseas continuar?`
    );

    if (confirmed) {
      const forceResult = await autoTranslate(true); // ‚úÖ Forzar sobrescritura
      if (forceResult.success) {
        alert(forceResult.message);
        setActiveLang(targetLang);
      } else {
        alert(forceResult.message);
      }
    } else {
      alert("‚ùå Traducci√≥n cancelada. No se realizaron cambios.");
    }
  } else if (result.success) {
    alert(result.message);
    setActiveLang(targetLang);
  } else {
    alert(result.message);
  }
}
```

**Badge din√°mico mejorado:**

```javascript
{
  !isView &&
    (() => {
      const missingTranslations = detectMissing();
      const hasMissingTranslations = missingTranslations.length > 0;
      const targetLang = activeLang === "es" ? "EN" : "ES"; // ‚úÖ Din√°mico

      return (
        <div className="flex gap-2">
          {/* Badge muestra direcci√≥n de traducci√≥n */}
          {hasMissingTranslations && (
            <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-300 font-medium">
              {missingTranslations.length} campo
              {missingTranslations.length > 1 ? "s" : ""} ‚Üí {targetLang}
            </span>
          )}

          <button
            onClick={handleAutoTranslate}
            disabled={translating}
            title={`Traducir autom√°ticamente ${activeLang.toUpperCase()} ‚Üí ${targetLang}`}
          >
            {translating ? (
              <>
                <span className="inline-block animate-spin mr-1">‚ü≥</span>
                Traduciendo...
              </>
            ) : (
              `üåê Traducir a ${targetLang}` // ‚úÖ Texto din√°mico
            )}
          </button>
        </div>
      );
    })();
}
```

---

## üß™ Escenarios de Prueba

### Prueba 1: Traducci√≥n ES ‚Üí EN con campos vac√≠os

**Pasos:**

1. Crear nuevo servicio
2. Completar campos en Espa√±ol
3. Clic "üåê Traducir a EN"

**Resultado esperado:**

- ‚úÖ Traduce autom√°ticamente
- ‚úÖ Cambia a vista EN
- ‚úÖ Alert: "‚úÖ ¬°Traducci√≥n completada!"

### Prueba 2: Traducci√≥n ES ‚Üí EN con campos existentes (edici√≥n)

**Pasos:**

1. Editar servicio existente con traducciones
2. Modificar "Caracter√≠sticas (ES)": agregar "Teor√≠a de la relatividad"
3. Clic "üåê Traducir a EN"

**Resultado esperado:**

- ‚úÖ Modal de confirmaci√≥n:

  ```
  ‚ö†Ô∏è Algunos campos ya tienen traducciones. ¬øDeseas sobreescribirlas?

  Traducci√≥n: ES ‚Üí EN

  ‚Ä¢ Algunos campos ya tienen traducciones
  ‚Ä¢ Si aceptas, se sobrescribir√°n con las nuevas traducciones

  ¬øDeseas continuar?
  ```

- Si acepta:
  - ‚úÖ Traduce TODO el campo (incluido el nuevo texto)
  - ‚úÖ Sobrescribe traducci√≥n anterior
  - ‚úÖ Cambia a vista EN
  - ‚úÖ Alert: "‚úÖ ¬°Traducci√≥n completada!"
- Si cancela:
  - ‚úÖ No hace cambios
  - ‚úÖ Alert: "‚ùå Traducci√≥n cancelada. No se realizaron cambios."

### Prueba 3: Traducci√≥n EN ‚Üí ES (bidireccional)

**Pasos:**

1. Cambiar a idioma Ingl√©s (EN)
2. Completar "Title (EN)": "Statistics Service"
3. Badge muestra: "1 campo ‚Üí ES"
4. Clic "üåê Traducir a ES"

**Resultado esperado:**

- ‚úÖ Traduce de EN a ES
- ‚úÖ Badge muestra: "1 campo ‚Üí ES"
- ‚úÖ Bot√≥n dice: "üåê Traducir a ES"
- ‚úÖ Cambia autom√°ticamente a vista ES
- ‚úÖ "T√≠tulo (ES)" contiene: "Servicio de Estad√≠stica"

### Prueba 4: Badge din√°mico en tiempo real

**Pasos:**

1. Crear servicio nuevo
2. Escribir solo "T√≠tulo (ES)"
3. Observar badge: "2 campos ‚Üí EN"
4. Escribir "Descripci√≥n (ES)"
5. Observar badge: "1 campo ‚Üí EN"
6. Escribir "Caracter√≠sticas (ES)"
7. Observar: Badge desaparece

**Resultado esperado:**

- ‚úÖ Badge actualiza en tiempo real
- ‚úÖ Cuenta correcta de campos faltantes
- ‚úÖ Desaparece cuando todo est√° completo
- ‚úÖ Muestra direcci√≥n correcta (‚Üí EN o ‚Üí ES)

### Prueba 5: Bot√≥n "Consult"/"Consultar" en preview

**Pasos:**

1. Editar servicio existente
2. Vista previa: Cambiar idioma Espa√±ol (ES)
3. Observar bot√≥n en card preview
4. Cambiar a Ingl√©s (EN)
5. Observar bot√≥n en card preview

**Resultado esperado:**

- ‚úÖ EN Espa√±ol: Bot√≥n muestra "Consultar"
- ‚úÖ EN Ingl√©s: Bot√≥n muestra "Consult"
- ‚úÖ Cambio inmediato al cambiar idioma

---

## ‚ö° Mejoras T√©cnicas

### 1. Performance

- ‚úÖ Rate limiting (150-200ms entre traducciones)
- ‚úÖ Detecci√≥n inteligente de cambios (evita traducciones innecesarias)
- ‚úÖ Traducci√≥n incremental (solo campos modificados)

### 2. UX

- ‚úÖ Confirmaci√≥n antes de sobrescribir
- ‚úÖ Badge din√°mico con direcci√≥n de traducci√≥n
- ‚úÖ Bot√≥n contextual ("Traducir a EN" vs "Traducir a ES")
- ‚úÖ Feedback visual: spinner animado
- ‚úÖ Mensajes claros y descriptivos

### 3. Escalabilidad

- ‚úÖ Hook reutilizable en Products, Services, Team, Research
- ‚úÖ Configuraci√≥n flexible (simpleFields, arrayFields, nestedFields)
- ‚úÖ Exportaci√≥n de `detectChanges` para uso avanzado
- ‚úÖ Documentaci√≥n completa en README.md

---

## üìã Checklist Final

- [x] Traducci√≥n bidireccional (ES‚ÜîEN)
- [x] Detecci√≥n de cambios en campos editados
- [x] Modal de confirmaci√≥n para sobrescritura
- [x] Badge din√°mico con conteo y direcci√≥n
- [x] Bot√≥n contextual (muestra idioma destino)
- [x] Bot√≥n "Consult"/"Consultar" funciona en preview
- [x] Sin errores de sintaxis
- [x] HMR funcional
- [x] Documentaci√≥n actualizada

---

**Desarrollado por:** NFT Dev Team  
**Fecha:** 14 de Octubre, 2025  
**Versi√≥n:** 2.0.0 - Traducci√≥n Bidireccional + Detecci√≥n de Cambios
